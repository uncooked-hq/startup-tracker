// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["job_tracker"]
}

model Job {
  id                String    @id @default(uuid())
  company_name      String
  industry          String?
  location          String
  funding_stage     String?
  role_title        String
  role_type         String    // e.g., Full-time, Part-time, Contract
  role_level        String    // e.g., Entry, Mid, Senior, Lead
  work_mode         String    // Onsite, Hybrid, Remote
  compensation      String
  equity            String?
  posting_date      DateTime  @default(now())
  closing_date      DateTime?
  company_description String
  application_link  String    @unique
  source_website    String
  is_active         Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([application_link])
  @@index([is_active])
  @@index([source_website])
  @@index([posting_date])
  @@schema("job_tracker")
}

// Represents real jobs regardless of source
// TODO: Update schema w duplicate handling refer to Linear ticket
model TrackerRole {
  id                   String   @id @default(uuid())
  
  // Company
  company_name         String
  company_domain       String?
  industry             String?
  funding_stage        String?
  
  // Role
  role_title           String
  role_level           String?
  role_type            String?
  work_mode            String?
  location             String?
  
  // Compensation
  compensation_text    String?
  salary_min           Int?
  salary_max           Int?
  salary_currency      String?
  offers_equity        Boolean?
  
  // Content
  company_description  String?
  role_description     String?
  
  // Dates
  posting_date         DateTime?
  closing_date         DateTime?
  
  // Status (derived)
  is_active            Boolean   @default(true)
  first_seen_at        DateTime  @default(now())
  last_seen_at         DateTime  @default(now())
  
  // Metadata
  created_at           DateTime  @default(now())
  updated_at           DateTime  @updatedAt
  
  // Relations (prisma virtual field no overhead)
  sources              TrackerRoleSource[] 
  
  @@unique([company_name, role_title])
  @@index([is_active, updated_at(sort: Desc)])
  @@index([company_name])
  @@index([role_title])
  @@index([last_seen_at])
  @@schema("job_tracker")
  @@map("tracker_roles")
}

// Represents all job instance from all jobs 
// 1 TrackerRole : N TrackerRoleSource(s)
model TrackerRoleSource {
  id                String   @id @default(uuid())
  
  // Relation to canonical role
  tracker_role_id   String
  tracker_role      TrackerRole @relation(fields: [tracker_role_id], references: [id], onDelete: Cascade)
  
  // Source information
  source            String
  source_role_id    String
  
  // URLs
  source_url        String
  application_url   String
  
  // Tracking
  last_seen_at      DateTime  @default(now())
  last_scraped_at   DateTime  @default(now())
  scrape_status     String    @default("success")
  
  // Raw data
  raw_payload       Json?
  
  // Metadata
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  
  @@unique([source, source_role_id])
  @@index([tracker_role_id])
  @@index([source])
  @@index([last_seen_at])
  @@index([scrape_status])
  @@schema("job_tracker")
  @@map("tracker_role_sources")
}

